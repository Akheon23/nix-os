#!/bin/rc

rfork en

if (~ $#PKGROOT 0) {
	PKGROOT=/
}

if (~ $#ROOT 0) {
	ROOT=/
}

if (~ $#* 0) {
	echo Need at least one package name to remove.
	exit 'invalid arg'
}

if (! test -e $ROOT^/contrib/packages/installed) {
	touch $ROOT^/contrib/packages/installed
}

for (PKGNAME in $*) {
	@{
		echo '###Removing package '^$PKGNAME^'###'
		
		# Go to the directory if it exists
		if (! test -e $PKGROOT^/contrib/packages/^$PKGNAME) {
			echo $PKGNAME^: No such package found in $PKGROOT^/contrib/packages/^$PKGNAME
			exit 'no such package'
		}
		cd $PKGROOT^/contrib/packages/^$PKGNAME
		
		if (! grep $PKGNAME $ROOT^/contrib/packages/installed >[2=1] >/dev/null) { 
			echo $PKGNAME^: Already removed!
		}
		if not {
			grep -v '^'^$PKGNAME^'$' $ROOT^/contrib/packages/installed> /tmp/installed-removed
			cp /tmp/installed-removed $ROOT^/contrib/packages/installed 

			rms=()
			files=''
			if(test -e root.tgz)
				files=`{tar ztf root.tgz}
			if not
				files=`{cat root.lst}
			for(f in $files){
				rms=($f $rms)
			}
			for(f in $rms){
				if(~ $ROOT /)
					echo rm -f $f
				if not
					echo rm -f $ROOT$f
				rm -f $ROOT$f
			}
		}
	}
}
