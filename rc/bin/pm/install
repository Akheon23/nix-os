#!/bin/rc

rfork en

if (~ $#PKGROOT 0) {
	PKGROOT=/
}

if (~ $#ROOT 0) {
	ROOT=/
}

if (~ $#PKGSERVER 0) {
	PKGSERVER=jfloren.net
}

verb=''
if(~ $1 -v){
	verb=-v
	shift
}

if (~ $#* 0) {
	echo Need at least one package name
	exit 'invalid arg'
}

if (! test -e $ROOT^/contrib/packages/installed) {
	touch $ROOT^/contrib/packages/installed
}

for (PKGNAME in $*) {
	@{	
		echo '###Installing package '^$PKGNAME^'###'
		
		# Go to the directory if it exists
		if (! test -e $PKGROOT^/contrib/packages/^$PKGNAME) {
			echo $PKGNAME^: No such package found in $PKGROOT^/contrib/packages/^$PKGNAME
			exit 'no such package'
		}
		cd $PKGROOT^/contrib/packages/^$PKGNAME
		
		# You need to do mk pull before running mk install
		if (! test -e root.tgz) {
			echo $PKGNAME^: pulling
			if(! pm/pull $PKGNAME){
				echo pull of $PKGNAME failed >[1=2]
				exit pull
			}
		}
		if (grep '^'^$PKGNAME^'$' $ROOT^/contrib/packages/installed >[2=1] >/dev/null) { echo $PKGNAME^: already installed}
		if not {
			# Install all the dependencies
			for (i in `{cat dep}) {
				if (! grep $i $ROOT^/contrib/packages/installed >[2=1] >/dev/null) {
					@{
					echo $PKGNAME^: Also installing dependency: $i
						cd $PKGROOT^/contrib/packages/$i
						pm/pull $i
						pm/install $i
					}
				} 
				if not {
					echo $i^' is already installed, skipping'
				}
			}
			echo $PKGNAME^: Unpacking the root archive...
			tar xzTf root.tgz
			@{builtin cd root && tar cif /fd/1 .} | @ {builtin cd $ROOT && tar x$verb^Tf /fd/0}

			# inform the world that this package is now installed
			echo $PKGNAME >> $ROOT^/contrib/packages/installed
			sort $ROOT^/contrib/packages/installed > /tmp/installed-sorted
			mv /tmp/installed-sorted $ROOT^/contrib/packages/installed
			echo $PKGNAME^: successfully installed.
		}
	}
}
