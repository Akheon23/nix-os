#!/bin/rc

rfork en

if (~ $#PKGROOT 0) {
	PKGROOT=/
}

if (~ $#ROOT 0) {
	ROOT=/
}

if (~ $#PKGSERVER 0) {
	PKGSERVER=jfloren.net
}

if (~ $#* 0) {
	echo Need at least one package name
	exit 'invalid arg'
}

if (! test -e $ROOT^/contrib/packages/installed) {
	touch $ROOT^/contrib/packages/installed
}

for (PKGNAME in $*) {
	@{	
		echo '•••Installing package '^$PKGNAME^'•••'
		
		# Go to the directory if it exists
		if (! test -e $PKGROOT^/contrib/packages/^$PKGNAME) {
			echo $PKGNAME^: No such package found in $PKGROOT^/contrib/packages/^$PKGNAME
			exit 'no such package'
		}
		cd $PKGROOT^/contrib/packages/^$PKGNAME
		
		# You need to do mk pull before running mk install
		if (! test -e root.tgz) {
			echo $PKGNAME^: You must pull first!
			exit
		}
		if (grep '^'^$PKGNAME^'$' $ROOT^/contrib/packages/installed >[2=1] >/dev/null) { echo $PKGNAME^: already installed}
		if not {
			# Install all the dependencies
			echo $PKGNAME^: Also installing dependencies:
			for (i in `{cat dep}) {
				echo '	* '^$i
			}
			for (i in `{cat dep}) {
				if (! grep $i $ROOT^/contrib/packages/installed >[2=1] >/dev/null) {
					@{
						cd $PKGROOT^/contrib/packages/$i
						pm/pull $i
						pm/install $i
					}
				} 
				if not {
					echo $i^' is already installed, skipping'
				}
			}
			echo $PKGNAME^: Unpacking the root archive...
			tar xzf root.tgz
			for (i in `{ls -p root}) {
				mkdir -p $ROOT^/$i
				echo $PKGNAME^: Copying files to $ROOT^/$i
				dircp root/$i $ROOT^/$i
			}
			# set permissions
			echo -n $PKGNAME^: Setting permissions
			awk '{ 
				perm = $3
				if ($3 ~ /20000000/) {
					sub(/20000000/, "", perm)
				} else if ($3 ~ /10000000/) {
					sub(/10000000/, "", perm)
				}
				print "echo -n .;"
				print "chmod "perm,"'$ROOT^/^'"$1";"		
				print "chgrp "$5,"'$ROOT^/^'"$1";"
			}' < db | rc
			echo
			# inform the world that this package is now installed
			echo $PKGNAME >> $ROOT^/contrib/packages/installed
			sort $ROOT^/contrib/packages/installed > /tmp/installed-sorted
			mv /tmp/installed-sorted $ROOT^/contrib/packages/installed
			echo $PKGNAME^: successfully installed.
		}
	}
}
